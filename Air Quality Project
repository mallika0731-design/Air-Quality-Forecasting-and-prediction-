import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from statsmodels.tsa.arima.model import ARIMA
from sklearn.preprocessing import StandardScaler
from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.ensemble import RandomForestRegressor
from xgboost import XGBRegressor
from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score

# Load data
file_path = 'Air quality India.csv'
df = pd.read_csv(file_path)

# Inspect data
print(df.info())
print(df.describe())

# Convert Timestamp to datetime
df['Timestamp'] = pd.to_datetime(df['Timestamp'])

# Plot 1: PM2.5 concentration over time
print("Plot 1: PM2.5 Concentration Over Time")
plt.figure(figsize=(12,6))
plt.plot(df['Timestamp'], df['PM2.5'], label='PM2.5')
plt.title('PM2.5 Concentration Over Time')
plt.xlabel('Timestamp')
plt.ylabel('PM2.5')
plt.legend()
plt.show()

# Resample to daily mean for smooth trend
daily_pm25 = df.resample('D', on='Timestamp')['PM2.5'].mean()

# Plot 2: Daily Mean PM2.5 Over Time
print("Plot 2: Daily Mean PM2.5 Over Time")
plt.figure(figsize=(12,5))
plt.plot(daily_pm25.index, daily_pm25.values)
plt.title('Daily Mean PM2.5 Over Time')
plt.ylabel('PM2.5')
plt.xlabel('Date')
plt.show()

# Yearly mean
df['Year'] = df['Timestamp'].dt.year
yearly_pm25 = df.groupby('Year')['PM2.5'].mean()

# Plot 3: Yearly Mean PM2.5
print("Plot 3: Yearly Mean PM2.5")
plt.figure(figsize=(8,5))
plt.bar(yearly_pm25.index, yearly_pm25.values)
plt.title('Yearly Mean PM2.5')
plt.xlabel('Year')
plt.ylabel('Mean PM2.5')
plt.show()

# Prepare features for ML
features = ['Year', 'Month', 'Day', 'Hour']
X = df[features]
y = df['PM2.5']

scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)

X_train, X_test, y_train, y_test = train_test_split(X_scaled, y, test_size=0.2, random_state=42)

# Random Forest regression and grid search
rf = RandomForestRegressor(random_state=42)
rf_params = {'n_estimators': [50, 100], 'max_depth': [5, 10]}
rf_grid = GridSearchCV(rf, rf_params, scoring='neg_mean_squared_error', cv=3)
rf_grid.fit(X_train, y_train)
rf_pred = rf_grid.best_estimator_.predict(X_test)

# XGBoost regression and grid search
xgb = XGBRegressor(objective='reg:squarederror', random_state=42)
xgb_params = {'n_estimators': [50, 100], 'max_depth': [5, 10], 'learning_rate': [0.1, 0.2]}
xgb_grid = GridSearchCV(xgb, xgb_params, scoring='neg_mean_squared_error', cv=3)
xgb_grid.fit(X_train, y_train)
xgb_pred = xgb_grid.best_estimator_.predict(X_test)

# Model evaluation
def eval_model(y_true, y_pred, name):
    print(f"{name} MAE: {mean_absolute_error(y_true, y_pred):.2f}")
    print(f"{name} RMSE: {np.sqrt(mean_squared_error(y_true, y_pred)):.2f}")
    print(f"{name} R2 Score: {r2_score(y_true, y_pred):.2f}")

print("Model Evaluation:")
eval_model(y_test, rf_pred, "Random Forest")
eval_model(y_test, xgb_pred, "XGBoost")

print("Best Random Forest params:", rf_grid.best_params_)
print("Best XGBoost params:", xgb_grid.best_params_)

# Plot 4: Actual vs Predicted PM2.5 for Random Forest and XGBoost
print("Plot 4: Actual vs Predicted PM2.5 (Test Data)")
plt.figure(figsize=(12,6))
plt.plot(range(len(y_test)), y_test.values, label='Actual PM2.5', alpha=0.7)
plt.plot(range(len(y_test)), rf_pred, label='Random Forest Prediction', linestyle='--')
plt.plot(range(len(y_test)), xgb_pred, label='XGBoost Prediction', linestyle='--')
plt.title('Actual vs Predicted PM2.5 (Test Data)')
plt.xlabel('Test sample index')
plt.ylabel('PM2.5')
plt.legend()
plt.show()

# Time series forecasting with ARIMA on daily mean PM2.5
pm25_series = daily_pm25.dropna()
arima_model = ARIMA(pm25_series, order=(2,1,2))
arima_fit = arima_model.fit()
forecast_days = 30
forecast = arima_fit.forecast(steps=forecast_days)

print(f"ARIMA forecast for next {forecast_days} days:\n", forecast)

# Plot 5: ARIMA forecasted next 30 days
print("Plot 5: Daily PM2.5 Forecast (ARIMA)")
future_index = pd.date_range(pm25_series.index[-1]+pd.Timedelta(days=1), periods=forecast_days)
plt.figure(figsize=(10,5))
plt.plot(pm25_series.index, pm25_series.values, label='Historical PM2.5')
plt.plot(future_index, forecast.values, label='Forecast', linestyle='--')
plt.title('Daily PM2.5 Forecast')
plt.xlabel('Date')
plt.ylabel('PM2.5')
plt.legend()
plt.show()

# Calculate percentage increase from last actual value to last forecasted value
last_actual = pm25_series.values[-1]
last_forecast = forecast.values[-1]
percent_increase = ((last_forecast - last_actual) / last_actual) * 100

# Print percentage increase statement
print(f"Predicted percentage increase in daily PM2.5 over the next {forecast_days} days: {percent_increase:.2f}%")

# Keep console open until key pressed
input("Press Enter to exit...")
